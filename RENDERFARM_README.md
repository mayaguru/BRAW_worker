# BRAW Render Farm

공유 폴더 기반 분산 렌더링 시스템

## 개요

3000 프레임을 10대 PC로 분산 처리하여 처리 시간을 1/10로 단축
- **기존**: PC 1대로 2시간+ → **렌더팜**: 10대로 약 12분

## 시스템 구조

```
2단계 병렬 처리
├─ 1단계: PC 간 분산 (10대 PC)
│   ├─ PC-1: 프레임 0-299
│   ├─ PC-2: 프레임 300-599
│   └─ ...
└─ 2단계: PC 내부 병렬 (각 PC마다 10개씩)
```

## 공유 폴더 구조

```
P:\00-GIGA\BRAW_CLI\
├─ workers\          # 워커 PC 등록 정보
│   ├─ PC-001.json
│   └─ PC-002.json
├─ jobs\             # 작업 큐
│   └─ job_xxxxx.json
├─ claims\           # 프레임 클레임 (중복 방지)
│   └─ job_xxxxx_000123_left.json
└─ completed\        # 완료 프레임
    └─ job_xxxxx_000123_left.done
```

## 사용 방법

### 1. 렌더팜 UI 실행

```bash
# 프로젝트 루트에서
run_farm_ui.bat
```

### 2. 작업 제출 (한 PC에서만)

**작업 제출 탭:**
1. BRAW 파일 선택
2. 출력 폴더 선택
3. 프레임 범위 설정
4. "작업 제출" 클릭

### 3. 워커 실행 (모든 PC에서)

**워커 탭:**
1. 병렬 작업 수 설정 (기본: 10)
2. "워커 시작" 클릭
3. 폴더를 자동 감시하며 작업 처리

### 4. 모니터링

**모니터링 탭:**
- 활성 워커 목록
- 작업 진행 상황
- 실시간 통계

## 핵심 기능

### 프레임 클레임 시스템 (중복 방지)
- 각 워커가 프레임을 atomic하게 claim
- 파일 시스템의 exclusive 모드 활용
- 타임아웃 (5분): 중단된 작업 자동 해제

### 하트비트 시스템
- 30초마다 워커 상태 업데이트
- 2분 이내 하트비트만 활성으로 간주
- 자동으로 오프라인 워커 감지

### 자동 작업 분배
- 워커가 자동으로 다음 프레임 선택
- 각 워커가 10개씩 병렬 처리
- 완료되면 자동으로 다음 작업 진행

## 설정

### 공유 폴더 경로 변경

`farm_core.py`:
```python
class FarmConfig:
    def __init__(self, farm_root: str = "P:/00-GIGA/BRAW_CLI"):
        # 여기서 경로 변경
```

### 병렬 처리 수 조정

UI에서 "병렬 작업 수" 설정 (1-50)

### 타임아웃 설정

`farm_core.py`:
```python
def is_expired(self, timeout_seconds=300):  # 5분
```

## 작동 원리

### 작업 제출
1. 사용자가 BRAW 파일 + 설정 입력
2. `jobs/` 폴더에 작업 정보 저장
3. 모든 워커가 감지

### 워커 처리
1. `jobs/` 폴더 감시 (5초마다)
2. 작업 발견 시 프레임 claim 시도
3. claim 성공하면 10개 병렬 처리
4. 완료 후 `completed/`에 기록
5. claim 해제 및 다음 작업

### 충돌 방지
- 파일 시스템의 exclusive open 사용
- 같은 프레임을 두 워커가 처리하지 않음
- 타임아웃으로 좀비 작업 방지

## 성능

**3000 프레임 처리 예상 시간:**
- PC 1대: 약 2시간
- PC 10대 (렌더팜): 약 12분 (10배 빠름)

**실제 성능은 다음에 따라 달라집니다:**
- 각 PC의 CPU/GPU 성능
- 네트워크 공유 폴더 속도
- BRAW 파일 크기 및 해상도

## 문제 해결

### 워커가 작업을 못 찾음
- `P:\00-GIGA\BRAW_CLI` 경로 접근 확인
- 네트워크 드라이브 연결 확인

### 프레임이 중복 처리됨
- claim 시스템 확인
- 파일 시스템 권한 확인

### 워커가 멈춤
- 타임아웃 설정 확인
- CLI 실행 오류 확인

## 로컬 모드 vs 렌더팜 모드

### 로컬 모드 (기존)
```bash
run_batch_ui.bat  # tkinter UI
```
- 단일 PC에서만 실행
- 10개 병렬 처리

### 렌더팜 모드 (신규)
```bash
run_farm_ui.bat  # PySide6 UI
```
- 여러 PC 분산 처리
- PC마다 10개 병렬 처리
- 공유 폴더 기반

## 요구사항

- Python 3.8+
- uv (패키지 관리)
- PySide6
- 공유 네트워크 폴더 접근 권한
- CLI: `braw_cli.exe`

## 라이센스

BRAW SDK 라이센스 준수
